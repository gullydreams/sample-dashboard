<!-- src/app/features/dashboard/health/health-dashboard/health-dashboard.component.html -->
<div class="dashboard-container">
    <!-- Error Banner -->
    <div class="error-banner" *ngIf="hasError">
        <mat-icon>error</mat-icon>
        <span>{{ errorMessage }}</span>
        <button class="retry-button" (click)="loadHealthData(true)">Retry</button>
    </div>

    <!-- Health Filter Bar -->
    <app-health-filter-bar [selectedDateRange]="selectedDateRange" [selectedTenantName]="selectedTenant?.name || ''"
        [selectedUseCaseName]="selectedUseCase?.name || ''" [tenants]="availableTenants" [useCases]="availableUseCases"
        [isRefreshing]="isRefreshing" (dateRangeChanged)="onDateRangeChanged($event)"
        (tenantChanged)="onTenantChanged($event)" (useCaseChanged)="onUseCaseChanged($event)"
        (refreshClicked)="onRefreshClicked()" (helpClicked)="onHelpClicked()">
    </app-health-filter-bar>

    <!-- Loading Indicator -->
    <div class="loading-overlay" *ngIf="isLoading">
        <div class="loading-spinner">
            <mat-icon class="rotating">refresh</mat-icon>
            <span>Loading health data...</span>
        </div>
    </div>

    <!-- Summary metrics - horizontal layout -->
    <div class="summary-bar" *ngIf="!isLoading">
        <app-metric-card title="Health Score" [value]="summaryData.healthScore || 0" icon="favorite"
            color="var(--primary-color)">
        </app-metric-card>

        <app-metric-card title="Pass Rate" [value]="summaryData.passRate || '0%'" [trend]="'up'" [trendValue]="'+2.3%'"
            icon="check_circle" color="var(--success-color)">
        </app-metric-card>

        <app-metric-card title="Failure Rate" [value]="summaryData.failureRate || '0%'" [trend]="'down'"
            [trendValue]="'-1.5%'" icon="error" color="var(--failure-color)">
        </app-metric-card>

        <app-metric-card title="Availability" [value]="summaryData.availability || '0%'" [trend]="'up'"
            [trendValue]="'+0.8%'" icon="cloud_done" color="var(--primary-color)">
        </app-metric-card>

        <app-metric-card title="Active Tests" [value]="summaryData.inProgress || 0" icon="hourglass_empty"
            color="#2196F3">
        </app-metric-card>
    </div>

    <!-- Account Pie Charts Grouped by Use Case - Using Google Charts -->
    <div class="dashboard-content" *ngIf="!isLoading">
        <div class="use-case-groups" *ngIf="accountChartGroups.length > 0">
            <div class="use-case-group" *ngFor="let group of accountChartGroups; trackBy: trackByGroupTitle">
                <div class="group-header">
                    <h2 class="group-title">{{ group.useCaseTitle }}</h2>
                    <div class="group-subtitle">{{ selectedTenant?.name }} - {{ group.useCaseTitle }} Accounts</div>
                </div>

                <div class="group-content">
                    <div class="charts-container">
                        <div class="charts-row">
                            <div class="pie-chart-card" *ngFor="let chart of group.charts; trackBy: trackByChartTitle">
                                <div class="chart-header">
                                    <h3>{{ chart.title }}</h3>
                                    <div class="success-rate">
                                        <span class="rate-label">Success:</span>
                                        <span class="rate-value">{{ chart.successRate }}%</span>
                                    </div>
                                </div>
                                <div class="chart-content">
                                    <!-- Use Google 3D Pie Chart -->
                                    <app-google-pie-chart [data]="chart.data" [labels]="chart.labels"
                                        [colors]="chart.colors" [is3D]="true" [showLegend]="false"
                                        [backgroundColor]="'transparent'" [pieSliceText]="'none'">
                                    </app-google-pie-chart>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Shared legend for the group -->
                    <div class="shared-legend">
                        <div class="legend-title">Status Legend</div>
                        <div class="legend-items">
                            <div class="legend-item" *ngFor="let label of getSharedLegendLabels(); let i = index">
                                <div class="legend-color" [style.background-color]="getSharedLegendColors()[i]"></div>
                                <div class="legend-label">{{ label }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- No data message -->
        <div class="no-data-message" *ngIf="accountChartGroups.length === 0">
            <mat-icon>info</mat-icon>
            <p>No account data available for the selected filters.</p>
            <p class="no-data-hint">Select a tenant and use case to view health metrics.</p>
        </div>
    </div>
</div>